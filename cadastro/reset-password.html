<!--
================================================
P√ÅGINA DE REDEFINI√á√ÉO DE SENHA - MATHKIDS
================================================
Esta p√°gina permite redefinir a senha atrav√©s de token seguro.

üîê FUNCIONALIDADES:
- Valida√ß√£o de token de reset
- Formul√°rio de nova senha com confirma√ß√£o
- Valida√ß√£o em tempo real
- Feedback visual de for√ßa da senha
- Redirecionamento autom√°tico ap√≥s sucesso

üé® DESIGN:
- Tema consistente com o sistema
- Interface amig√°vel para pais/respons√°veis
- Anima√ß√µes suaves e feedback visual
- Design responsivo

üîß INTEGRA√á√ÉO:
- API backend: /api/reset-password
- Valida√ß√£o de token via URL params
- JavaScript: reset-password.js
================================================
-->

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Redefinir Senha - MathKids üêâ</title>

<link rel="stylesheet" href="../assets/css/shared.css">
<link rel="stylesheet" href="../assets/css/entrar.css">
<link rel="stylesheet" href="../assets/css/redefinir.css">
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

</head>

<body>

     <!-- Se√ß√£o do mascote - drag√£o amig√°vel para tranquilizar crian√ßas -->
        <div class="mascot-section">
            <div class="mascot-image" role="img" aria-label="Drag√£o verde e fofo do MathKids segurando um tablet"></div>
        </div>
     <div class="reset-container">        

        <!-- √Årea de mensagens -->
        <div id="messageArea"></div>

        <!-- Formul√°rio de redefini√ß√£o -->
        <form id="resetPasswordForm">
            <!-- Campo de nova senha -->
            <div class="form-group">                
                <div class="input-with-icon">
                    <input type="password" id="newPassword" placeholder="Nova senha" required>
                    <i class="fas fa-eye toggle-password" data-target="newPassword"></i>
                </div>
                
               
            </div>

            <!-- Campo de confirma√ß√£o de senha -->
            <div class="form-group">               
                <div class="input-with-icon">
                    <input type="password" id="confirmPassword" placeholder="Repetir senha" required>
                    <i class="fas fa-eye toggle-password" data-target="confirmPassword"></i>
                </div>
                <div id="passwordMatchMessage" style="margin-top: 8px; font-size: 0.875rem;"></div>
            </div>

            <!-- Bot√£o de redefinir -->
            <button type="submit" class="btn-reset" id="submitBtn">
                <i class="fas fa-lock"></i> Atualizar Senha
            </button>
        </form>

        <!-- Link para voltar ao login -->
        <div class="back-link">
            <a href="entrar.html">
                <i class="fas fa-arrow-left"></i>
                Voltar ao Login
            </a>
        </div>

        <!-- Bot√£o de teste para desenvolvimento -->
        <div id="devTestSection" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px dashed #ccc; display: none;">
            <p style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">
                <strong>Modo Desenvolvimento:</strong> Use este bot√£o para testar a funcionalidade
            </p>
            <button type="button" id="testResetBtn" class="btn-reset" style="margin-bottom: 0; background: #6c757d;">
                <i class="fas fa-cog"></i> Testar Reset (Dev)
            </button>
        </div>
    </div>

    <!-- JavaScript da funcionalidade -->
    <script>
        class ResetPasswordSystem {
            constructor() {
                console.log('üîß Iniciando ResetPasswordSystem...');
                this.apiBaseUrl = this.getApiBaseUrl();
                this.token = null;
                this.email = null;
                
                console.log('üîß Construtor finalizado, chamando init()...');
                this.init();
            }

            getApiBaseUrl() {
                const hostname = window.location.hostname;
                const protocol = window.location.protocol;
                const port = window.location.port;
                
                // Debug de informa√ß√µes da URL
                console.log('üåê URL Info:', {
                    hostname: hostname,
                    protocol: protocol,
                    port: port,
                    origin: window.location.origin
                });
                
                if (hostname === 'localhost' || hostname === '127.0.0.1') {
                    return 'http://localhost:5000';
                }
                
                if (hostname.includes('onrender.com') || hostname.includes('mathkids')) {
                    return 'https://mathkids-back.onrender.com';
                }
                
                // Fallback para desenvolvimento local
                return 'http://localhost:5000';
            }

            init() {
                // Extrair par√¢metros da URL
                this.parseUrlParams();
                
                console.log('üîê Sistema de reset de senha inicializado');
                console.log('üîç API Base URL:', this.apiBaseUrl);
                console.log('üîç Token dispon√≠vel:', !!this.token);
                console.log('üîç Email dispon√≠vel:', !!this.email);
                
                // Para desenvolvimento/teste, permitir funcionamento sem token/email
                const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                
                // Se n√£o h√° token em produ√ß√£o, mostrar erro
                if ((!this.token || !this.email) && !isDevelopment) {
                    const errorMsg = 'Link inv√°lido ou expirado. Solicite um novo link de recupera√ß√£o.';
                    console.error('‚ùå Par√¢metros inv√°lidos:', {
                        hasToken: !!this.token,
                        hasEmail: !!this.email,
                        tokenLength: this.token ? this.token.length : 0,
                        email: this.email
                    });
                    this.showMessage(errorMsg, 'error');
                    return;
                }

                // Em desenvolvimento, usar valores mock se n√£o houver token/email
                if (isDevelopment && (!this.token || !this.email)) {
                    this.token = this.token || 'dev-token-123456789';
                    this.email = this.email || 'test@mathkids.com';
                    console.log('‚ö†Ô∏è Modo desenvolvimento: usando valores mock');
                    this.showMessage('Modo desenvolvimento: usando valores de teste', 'info');
                }

                // Configurar event listeners
                this.setupEventListeners();
                
                // Mostrar se√ß√£o de desenvolvimento se necess√°rio
                this.setupDevelopmentMode();
                
                // Testar conex√£o com o servidor
                this.testServerConnection();
            }

            setupDevelopmentMode() {
                const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                const devSection = document.getElementById('devTestSection');
                
                if (isDevelopment && devSection) {
                    devSection.style.display = 'block';
                }
            }

            runDevelopmentTest() {
                // Preencher campos com dados de teste
                document.getElementById('newPassword').value = 'teste123';
                document.getElementById('confirmPassword').value = 'teste123';
                
                // Simular submiss√£o
                this.showMessage('Dados de teste preenchidos. Clique em "Atualizar Senha" para testar.', 'info');
            }

            async testServerConnection() {
                try {
                    console.log('üîç Testando conex√£o com o servidor...');
                    const response = await fetch(`${this.apiBaseUrl}/health`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    if (response.ok) {
                        console.log('‚úÖ Servidor conectado com sucesso');
                    } else {
                        console.log('‚ö†Ô∏è Servidor respondeu mas com status:', response.status);
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao testar conex√£o com servidor:', error);
                    
                    // Em desenvolvimento, mostrar aviso
                    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                        this.showMessage(`Aviso: N√£o foi poss√≠vel conectar ao servidor (${this.apiBaseUrl}). Verifique se est√° rodando.`, 'info');
                    }
                }
            }

            parseUrlParams() {
                const urlParams = new URLSearchParams(window.location.search);
                this.token = urlParams.get('token');
                this.email = urlParams.get('email');
                
                console.log('üîç URL completa:', window.location.href);
                console.log('üîç Query string:', window.location.search);
                console.log('üîç Par√¢metros extra√≠dos:', { 
                    hasToken: !!this.token, 
                    tokenLength: this.token ? this.token.length : 0,
                    tokenPreview: this.token ? this.token.substring(0, 20) + '...' : 'NULL',
                    email: this.email 
                });
                
                // Verificar se os par√¢metros s√£o v√°lidos
                if (!this.token || this.token.length < 10) {
                    console.error('‚ùå Token inv√°lido ou muito curto:', this.token);
                }
                
                if (!this.email || !this.email.includes('@')) {
                    console.error('‚ùå Email inv√°lido:', this.email);
                }
            }

            setupEventListeners() {
                const form = document.getElementById('resetPasswordForm');
                const newPasswordInput = document.getElementById('newPassword');
                const confirmPasswordInput = document.getElementById('confirmPassword');

                // Verificar se os elementos existem
                if (!form || !newPasswordInput || !confirmPasswordInput) {
                    console.error('‚ùå Elementos do formul√°rio n√£o encontrados:', {
                        form: !!form,
                        newPasswordInput: !!newPasswordInput,
                        confirmPasswordInput: !!confirmPasswordInput
                    });
                    this.showMessage('Erro: Formul√°rio n√£o encontrado. Recarregue a p√°gina.', 'error');
                    return;
                }

                console.log('‚úÖ Elementos do formul√°rio encontrados, configurando listeners...');

                // Submiss√£o do formul√°rio
                form.addEventListener('submit', (e) => this.handleSubmit(e));

                // Valida√ß√£o em tempo real da senha
                newPasswordInput.addEventListener('input', () => {
                    this.validatePassword();
                    this.checkPasswordMatch();
                });

                // Valida√ß√£o de confirma√ß√£o de senha
                confirmPasswordInput.addEventListener('input', () => {
                    this.checkPasswordMatch();
                });

                // Toggle de visibilidade da senha
                document.querySelectorAll('.toggle-password').forEach(toggle => {
                    toggle.addEventListener('click', () => this.togglePasswordVisibility(toggle));
                });

                // Bot√£o de teste para desenvolvimento
                const testBtn = document.getElementById('testResetBtn');
                if (testBtn) {
                    testBtn.addEventListener('click', () => this.runDevelopmentTest());
                }
                
                console.log('‚úÖ Event listeners configurados com sucesso');
            }

            validatePassword() {
                const password = document.getElementById('newPassword').value;
                
                // Verificar requisitos b√°sicos
                const requirements = {
                    length: password.length >= 6,
                    letter: /[a-zA-Z]/.test(password),
                    number: /\d/.test(password)
                };

                // Retornar se a senha atende aos requisitos m√≠nimos
                return requirements.length && requirements.letter;
            }

            checkPasswordMatch() {
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                const messageElement = document.getElementById('passwordMatchMessage');

                if (confirmPassword.length === 0) {
                    messageElement.textContent = '';
                    return true;
                }

                if (newPassword === confirmPassword) {
                    messageElement.innerHTML = '<i class="fas fa-check" style="color: var(--primary-green);"></i> Senhas conferem';
                    messageElement.style.color = 'var(--primary-green)';
                    return true;
                } else {
                    messageElement.innerHTML = '<i class="fas fa-times" style="color: #ff4757;"></i> Senhas n√£o conferem';
                    messageElement.style.color = '#ff4757';
                    return false;
                }
            }

            togglePasswordVisibility(toggle) {
                const targetId = toggle.getAttribute('data-target');
                const input = document.getElementById(targetId);
                
                if (input.type === 'password') {
                    input.type = 'text';
                    toggle.className = 'fas fa-eye-slash toggle-password';
                } else {
                    input.type = 'password';
                    toggle.className = 'fas fa-eye toggle-password';
                }
            }

            async handleSubmit(event) {
                event.preventDefault();
                
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                const submitBtn = document.getElementById('submitBtn');

                // Valida√ß√µes
                if (!newPassword || newPassword.trim() === '') {
                    this.showMessage('Por favor, digite uma nova senha', 'error');
                    return;
                }

                if (!confirmPassword || confirmPassword.trim() === '') {
                    this.showMessage('Por favor, confirme a nova senha', 'error');
                    return;
                }

                if (!this.validatePassword()) {
                    this.showMessage('A senha deve ter pelo menos 6 caracteres e conter letras', 'error');
                    return;
                }

                if (!this.checkPasswordMatch()) {
                    this.showMessage('As senhas n√£o conferem', 'error');
                    return;
                }

                // Mostrar loading
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';

                try {
                    console.log('üîÑ Enviando solicita√ß√£o de reset de senha');
                    console.log('üìß Email:', this.email);
                    console.log('üîê Token (primeiros 20 chars):', this.token ? this.token.substring(0, 20) + '...' : 'NULL');
                    console.log('üåê API URL:', `${this.apiBaseUrl}/api/reset-password`);
                    
                    const requestBody = {
                        token: this.token,
                        email: this.email,
                        newPassword: newPassword
                    };
                    
                    console.log('üì¶ Request body:', JSON.stringify(requestBody, (key, value) => {
                        if (key === 'newPassword') return '[HIDDEN]';
                        if (key === 'token') return value ? value.substring(0, 20) + '...' : 'NULL';
                        return value;
                    }));
                    
                    const response = await fetch(`${this.apiBaseUrl}/api/reset-password`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody)
                    });

                    console.log('üì° Response status:', response.status);
                    console.log('üì° Response ok:', response.ok);

                    const data = await response.json();
                    console.log('üì¶ Response data:', data);

                    if (response.ok) {
                        console.log('‚úÖ Senha redefinida com sucesso');
                        this.showMessage(data.message, 'success');
                        
                        // Redirecionar para login ap√≥s 3 segundos
                        setTimeout(() => {
                            window.location.href = 'entrar.html';
                        }, 3000);
                        
                    } else {
                        console.error('‚ùå Erro na resposta:', data);
                        this.showMessage(data.message || 'Erro ao redefinir senha', 'error');
                    }

                } catch (error) {
                    console.error('‚ùå Erro na redefini√ß√£o de senha:', error);
                    
                    let errorMessage = 'Erro de conex√£o. Tente novamente.';
                    
                    // Tratar erros espec√≠ficos
                    if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                        errorMessage = `Erro de conex√£o com o servidor. Verifique sua conex√£o com a internet e tente novamente.`;
                        console.error('üíª Problema de conectividade. URL do servidor:', this.apiBaseUrl);
                        
                        // Em desenvolvimento, mostrar mais detalhes
                        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                            errorMessage += ` (Servidor tentado: ${this.apiBaseUrl})`;
                        }
                    } else if (error.name === 'SyntaxError') {
                        errorMessage = 'Erro na resposta do servidor. Tente novamente.';
                        console.error('üì° Resposta inv√°lida do servidor');
                    } else {
                        errorMessage = `Erro inesperado: ${error.message}`;
                    }
                    
                    this.showMessage(errorMessage, 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-lock"></i> Atualizar Senha';
                }
            }

            showMessage(message, type = 'info') {
                const messageArea = document.getElementById('messageArea');
                const icon = type === 'success' ? 'fa-check-circle' : 
                            type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle';
                
                messageArea.innerHTML = `
                    <div class="message ${type}" style="display: flex;">
                        <i class="fas ${icon}"></i>
                        ${message}
                    </div>
                `;
                
                // Log para debug
                console.log(`üì¢ Mensagem (${type}):`, message);
                
                // Scroll para a mensagem
                messageArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìÑ DOM carregado, inicializando sistema de reset...');
            try {
                new ResetPasswordSystem();
                console.log('‚úÖ Sistema inicializado com sucesso');
            } catch (error) {
                console.error('‚ùå Erro ao inicializar sistema:', error);
                
                // Tentar mostrar erro na tela se poss√≠vel
                const messageArea = document.getElementById('messageArea');
                if (messageArea) {
                    messageArea.innerHTML = `
                        <div class="message error" style="display: flex;">
                            <i class="fas fa-exclamation-triangle"></i>
                            Erro ao inicializar p√°gina. Recarregue e tente novamente.
                        </div>
                    `;
                }
            }
        });
    </script>

</body>
</html>